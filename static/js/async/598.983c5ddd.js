"use strict";(self.webpackChunkvue2_amis=self.webpackChunkvue2_amis||[]).push([["598"],{69368:function(t,e,n){n.r(e),n.d(e,{TableControlRenderer:()=>b,default:()=>v});var i=n(9787),r=n(65758),a=n(47755),s=n(68333),o=n(59245),l=n.n(o),u=n(33170),d=n.n(u),c=n(66292),p=n.n(c),h=n(11333),m=n.n(h),f="__isPlaceholder",v=function(t){function e(e){var n=t.call(this,e)||this;n.entityId=1,n.subForms={},n.subFormItems={},n.rowPrinstine=[],n.editting={},n.toDispose=[],n.lazyEmitValue=p()(n.emitValue.bind(n),50,{trailing:!0,leading:!1}),n.emittedValue=null;var r=e.addHook,s=Array.isArray(e.value)?e.value.concat():[];return n.state=(0,i.pi)({columns:n.buildColumns(e),editIndex:"",items:s},n.transformState(s)),n.entries=new a.arw,n.buildItemProps=n.buildItemProps.bind(n),n.confirmEdit=n.confirmEdit.bind(n),n.cancelEdit=n.cancelEdit.bind(n),n.handleSaveTableOrder=n.handleSaveTableOrder.bind(n),n.handleTableSave=n.handleTableSave.bind(n),n.handleRadioChange=n.handleRadioChange.bind(n),n.getEntryId=n.getEntryId.bind(n),n.subFormRef=n.subFormRef.bind(n),n.subFormItemRef=n.subFormItemRef.bind(n),n.handlePageChange=n.handlePageChange.bind(n),n.handleTableQuery=n.handleTableQuery.bind(n),n.emitValue=n.emitValue.bind(n),n.tableRef=n.tableRef.bind(n),n.flush=n.flush.bind(n),n.filterItemIndex=n.filterItemIndex.bind(n),r&&n.toDispose.push(r(n.flush,"flush")),n}return(0,i.ZT)(e,t),e.prototype.componentDidUpdate=function(t,e){var n=this.props,r=null;if(t.disabled!==n.disabled||t.static!==n.static||n.$schema.disabled!==t.$schema.disabled||n.$schema.static!==t.$schema.static){var a=this.state.items.filter(function(t){return!t.hasOwnProperty(f)});r=(0,i.pi)((0,i.pi)((0,i.pi)((0,i.pi)({},r),{items:a}),this.transformState(a)),{editIndex:"",columns:this.buildColumns(n)})}if(n.columns!==t.columns&&(r=(0,i.pi)((0,i.pi)({},r),{columns:this.buildColumns(n)})),n.value!==t.value&&n.value!==this.emittedValue){var a=Array.isArray(n.value)?n.value.concat():[];r=(0,i.pi)((0,i.pi)((0,i.pi)((0,i.pi)({},r),{items:a}),this.transformState(a)),{editIndex:""})}r&&this.setState(r)},e.prototype.componentWillUnmount=function(){this.entries.dispose(),this.lazyEmitValue.cancel(),this.toDispose.forEach(function(t){return t()}),this.toDispose=[]},e.prototype.transformState=function(t,e,n){var r=this.props,s=r.perPage,o=r.matchFunc,l=(0,i.pi)((0,i.pi)({},this.state),e),u=l.query,d=l.page,c=null!=u?u:{},p=c.orderBy,h=c.orderDir,m=(0,i._T)(c,["orderBy","orderDir"]);Object.keys(m).length&&(t=(0,a.Oab)(t,{query:m,columns:this.state.columns,matchFunc:"string"==typeof o&&o?(0,a.PqP)(o,"items","itemsRaw","options"):"function"==typeof o?o:void 0})),p&&(t=(0,a.qrZ)(t.concat(),p,"string"==typeof h&&/desc/i.test(h)?-1:1));var f=t.length;if(d=Math.min(null!=d?d:1,"number"==typeof s?Math.max(1,Math.ceil(f/s)):1),n){var v=t.indexOf(n);~v&&(d=Math.ceil((v+1)/s))}return"number"==typeof s&&s&&t.length>s&&(t=t.slice((d-1)*s,d*s)),{filteredItems:t,page:d,total:f}},e.prototype.flush=function(){return(0,i.mG)(this,void 0,void 0,function(){var t,e,n=this;return(0,i.Jh)(this,function(i){switch(i.label){case 0:return t=[],Object.keys(this.subForms).forEach(function(e){return n.subForms[e]&&t.push(n.subForms[e])}),[4,Promise.all(t.map(function(t){return t.flush()}))];case 1:return i.sent(),e=[],Object.keys(this.subFormItems).forEach(function(t){return n.subFormItems[t]&&e.push(n.subFormItems[t])}),[4,Promise.all(e.map(function(t){var e,n;return null==(n=(e=t.props).onFlushChange)?void 0:n.call(e)}))];case 2:return i.sent(),[4,this.lazyEmitValue.flush()];case 3:return i.sent(),[2]}})})},e.prototype.resolveVariableProps=function(t,e){var n={minLength:0,maxLength:1/0},i=t[e];if(!i)return n[e];if("string"==typeof i)if((0,a.SSQ)(i)){var r=(0,a.OgC)(i,t.data,"| raw");i="number"==typeof r&&r>=0?r:n[e]}else{var s=parseInt(i,10);i=isNaN(s)?n[e]:s}return i},e.prototype.subFormRef=function(t,e,n){this.subForms["".concat(e,"-").concat(n)]=t},e.prototype.subFormItemRef=function(t,e,n){this.subFormItems["".concat(e,"-").concat(n)]=t},e.prototype.validate=function(){return(0,i.mG)(this,void 0,void 0,function(){var t,e,n,r,s,o,l,u,d,c,p=this;return(0,i.Jh)(this,function(i){switch(i.label){case 0:if(e=(t=this.props).value,n=t.translate,r=t.columns,s=this.resolveVariableProps(this.props,"minLength"),o=this.resolveVariableProps(this.props,"maxLength"),this.state.editIndex)return[2,n("Table.editing")];if(!(s&&(!Array.isArray(e)||e.length<s)))return[3,1];return[2,n("Combo.minLength",{minLength:s})];case 1:if(!(o&&Array.isArray(e)&&e.length>o))return[3,2];return[2,n("Combo.maxLength",{maxLength:o})];case 2:if(l=[],Object.keys(this.subForms).forEach(function(t){return p.subForms[t]&&l.push(p.subForms[t])}),!l.length)return[3,4];return[4,Promise.all(l.map(function(t){return t.validate()}))];case 3:if(u=~i.sent().indexOf(!1)?n("Form.validateFailed"):"",d="",!u&&Array.isArray(r)&&Array.isArray(e)&&r.some(function(t){if(t.unique&&t.name){var n=[];return e.some(function(e){var i=(0,a.E04)(e,t.name);return~n.indexOf(i)?(d="".concat(t.label||t.name),!0):(n.push(i),!1)})}return!1})&&(u=n("InputTable.uniqueError",{label:d})),u)return[2,u];i.label=4;case 4:return c=[],Object.keys(this.subFormItems).forEach(function(t){return p.subFormItems[t]&&c.push(p.subFormItems[t])}),[4,Promise.all(c.map(function(t){return t.props.onValidate()}))];case 5:return[2,~i.sent().indexOf(!1)?n("Form.validateFailed"):""]}})})},e.prototype.emitValue=function(t){return(0,i.mG)(this,void 0,void 0,function(){var e,n,r;return(0,i.Jh)(this,function(i){switch(i.label){case 0:return e=null!=t?t:this.state.items.filter(function(t){return!t.hasOwnProperty(f)}),n=this.props.onChange,[4,this.dispatchEvent("change")];case 1:return(r=i.sent())||(this.emittedValue=e,null==n||n(e)),[2,r]}})})},e.prototype.doAction=function(t,e){for(var n,r,s=[],o=2;o<arguments.length;o++)s[o-2]=arguments[o];return(0,i.mG)(this,void 0,void 0,function(){var o,l,u,c,p,h,m,v,b,y,I,g,x,C,w,E,P,R=this;return(0,i.Jh)(this,function(k){switch(k.label){case 0:if(l=(o=this.props).onAction,u=o.valueField,c=o.env,p=o.needConfirm,h=o.addable,m=o.addApi,v=o.translate,b=o.onChange,"add"!==(y=t.actionType))return[3,6];if(!1===h)return[2];if(I=this.state.items.concat(),!(m||t.payload))return[3,4];if(g=null,!(0,a.X1t)(m,e))return[3,2];return[4,c.fetcher(m,e)];case 1:if((x=k.sent())&&!x.ok)return(null==m?void 0:m.silent)||c.notify("error",null!=(r=null==(n=null==m?void 0:m.messages)?void 0:n.failed)?r:x.msg||v("fetchFailed")),[2];return x&&x.ok&&(g=x.data),[3,3];case 2:g=(0,a.buJ)(t.payload,e),k.label=3;case 3:return(g=Array.isArray(g)?g:[g]).forEach(function(t){u&&d()(I,function(e){return e[u]==t[u]})||(I.push(t),!1!==p&&Reflect.set(t,f,!0))}),this.setState((0,i.pi)({items:I},this.transformState(I)),function(){1===g.length&&!1!==p?R.startEdit("".concat(I.length-1),!0):null==b||b(I)}),[2];case 4:return[2,this.addItem("".concat(I.length-1),!1)];case 5:return[3,7];case 6:if("remove"===y||"delete"===y){if(!u)return[2,c.alert(v("Table.valueField"))];if(!t.payload)return[2,c.alert(v("Table.playload"))];return C=this.state.items.concat(),(w=Array.isArray(w=(0,a.buJ)(t.payload,e))?w:[w]).forEach(function(t){var e=(0,a.L$8)(C,function(e){return e[u]==t[u]});(null==e?void 0:e.length)&&(C=(0,a.o5f)(C,e,1))}),this.setState((0,i.pi)({items:C},this.transformState(C)),function(){null==b||b(C)}),[2]}"initDrag"===y?(E=this.table).doAction.apply(E,(0,i.ev)([t,e],(0,i.CR)(s),!1)):"cancelDrag"===y&&(P=this.table).doAction.apply(P,(0,i.ev)([t,e],(0,i.CR)(s),!1)),k.label=7;case 7:return[2,l&&l.apply(void 0,(0,i.ev)([t,e],(0,i.CR)(s),!1))]}})})},e.prototype.copyItem=function(t){return(0,i.mG)(this,void 0,void 0,function(){var e,n,r,s,o,l,u,d,c,p,h,m,v,b,y,I,g=this;return(0,i.Jh)(this,function(x){return n=(e=this.props).needConfirm,r=e.data,o=void 0===(s=e.copyData)?{"&":"$$"}:s,l=this.state.items.concat(),d=(u=t.split(".").map(function(t){return parseInt(t,10)})).concat(),d[d.length-1]+=1,c=l,p=(0,a.IMU)(l,u),h=(0,a.buJ)(o,(0,a.nW9)(r,p)),l=!1===n?(0,a.o5f)(l,d,0,h):(0,a.o5f)(l,d,0,(0,i.pi)((0,i.pi)({},h),((I={})[f]=!0,I))),this.reUseRowId(l,c,d),m=l[d[0]],(v=(0,i.pi)((0,i.pi)({},this.transformState(l)),{items:l})).filteredItems.includes(m)||(b=l[u[0]],y=v.filteredItems.findIndex(function(t){return t===b}),v.filteredItems.splice(y+1,0,m)),this.setState(v,function(){return(0,i.mG)(g,void 0,void 0,function(){return(0,i.Jh)(this,function(t){switch(t.label){case 0:return[4,this.dispatchEvent("add",{index:d[d.length-1],indexPath:d.join("."),item:h})];case 1:if(t.sent())return[2];return!1===n?this.emitValue():this.startEdit(d.join("."),!0),[2]}})})}),[2]})})},e.prototype.addItem=function(t,e,n){return void 0===e&&(e=!0),(0,i.mG)(this,void 0,void 0,function(){var r,s,o,l,u,d,c,p,h,v,b,y,I,g,x,C=this;return(0,i.Jh)(this,function(w){return t=t||"".concat(this.state.items.length-1),s=(r=this.props).needConfirm,o=r.scaffold,l=r.columns,u=r.data,r.perPage,d=this.state.items.concat(),(x={})[f]=!0,c=x,Array.isArray(l)&&l.forEach(function(t){if(void 0!==t.value&&"string"==typeof t.name)if("type"in t&&("input-date"===t.type||"input-datetime"===t.type||"input-time"===t.type||"input-month"===t.type||"input-quarter"===t.type||"input-year"===t.type)){if("string"!=typeof t.value||""!==t.value.trim()){var e=(0,a.kXI)(t.value,u,t.format||"X");(0,a.NI0)(c,t.name,(t.utc?m().utc(e):e).format(t.format||"X"))}}else(0,a.UTL)(t.value)||(0,a.NI0)(c,t.name,t.value)}),c=(0,i.pi)((0,i.pi)({},c),o),!1===s&&Reflect.deleteProperty(c,f),h=(p=t.split(".").map(function(t){return parseInt(t,10)})).concat(),h[h.length-1]+=1,v=d,d=(0,a.o5f)(d,h,0,c),this.reUseRowId(d,v,h),b=d[h[0]],(y=(0,i.pi)((0,i.pi)({items:d},this.transformState(d,void 0,b)),!1===s?{}:{editIndex:h.join("."),isCreateMode:!0,columns:this.buildColumns(this.props,!0,"".concat(t))})).filteredItems.includes(b)||(I=d[p[0]],g=y.filteredItems.findIndex(function(t){return t===I}),y.filteredItems.splice(g+1,0,b)),this.setState(y,function(){return(0,i.mG)(C,void 0,void 0,function(){return(0,i.Jh)(this,function(t){switch(t.label){case 0:if(!e)return[3,2];return[4,this.dispatchEvent("add",{index:h[h.length-1],indexPath:h.join("."),item:c})];case 1:t.sent(),t.label=2;case 2:return!1===s&&this.emitValue(),null==n||n(),[2]}})})}),[2,!1]})})},e.prototype.subAddItem=function(t,e,n){return void 0===e&&(e=!0),(0,i.mG)(this,void 0,void 0,function(){return(0,i.Jh)(this,function(i){return[2,this.addItem(t+".-1",e,function(){null==n||n.setExpanded(!0)})]})})},e.prototype.editItem=function(t){return(0,i.mG)(this,void 0,void 0,function(){var e,n,r;return(0,i.Jh)(this,function(i){switch(i.label){case 0:return e=this.state.items,n=t.split(".").map(function(t){return parseInt(t,10)}),r=(0,a.IMU)(e,n),[4,this.dispatchEvent("edit",{index:n[n.length-1],indexPath:n.join("."),item:r})];case 1:return i.sent()||this.startEdit(t,!0),[2]}})})},e.prototype.dispatchEvent=function(t,e){return void 0===e&&(e={}),(0,i.mG)(this,void 0,void 0,function(){var n,r,s,o,l;return(0,i.Jh)(this,function(u){switch(u.label){case 0:return n=this.props.dispatchEvent,s=(r=this.state).items,o=r.rowIndex,[4,n(t,(0,a.vXk)(this.props,(0,i.pi)({value:(0,i.ev)([],(0,i.CR)(s),!1),rowIndex:o},e)))];case 1:return[2,!!(null==(l=u.sent())?void 0:l.prevented)]}})})},e.prototype.startEdit=function(t,e){void 0===e&&(e=!1),this.setState({editIndex:t,isCreateMode:e,columns:this.buildColumns(this.props,e,t)})},e.prototype.confirmEdit=function(){var t,e,n;return(0,i.mG)(this,void 0,void 0,function(){var r,s,o,l,u,d,c,p,h,m,v,b,y,I,g,x,C,w=this;return(0,i.Jh)(this,function(E){switch(E.label){case 0:return s=(r=this.props).addApi,o=r.updateApi,l=r.data,u=r.env,d=r.translate,c=[],Object.keys(this.subForms).forEach(function(t){return w.subForms[t]&&c.push(w.subForms[t])}),c.forEach(function(t){return t.flush()}),p=[],Object.keys(this.subFormItems).forEach(function(t){return w.subFormItems[t]&&p.push(w.subFormItems[t])}),p.forEach(function(t){var e,n;return null==(n=(e=t.props).onFlushChange)?void 0:n.call(e)}),[4,Promise.all(c.map(function(t){return t.validate()}).concat(p.map(function(t){return t.props.onValidate()})))];case 1:if(~E.sent().indexOf(!1))return[2];return h=this.state.items.concat(),m=this.state.editIndex.split(".").map(function(t){return parseInt(t,10)}),y=(b=(v=(0,i.pi)({},(0,a.IMU)(h,m))).hasOwnProperty(f))?"addConfirm":"editConfirm",[4,this.dispatchEvent(y,{index:m[m.length-1],indexPath:m.join("."),item:v})];case 2:if(E.sent())return[2];if(I=null,g=void 0,!(b&&(0,a.X1t)(s,(0,a.nW9)(l,v))))return[3,4];return[4,u.fetcher(s,(0,a.nW9)(l,v))];case 3:return I=E.sent(),g=null==(t=null==s?void 0:s.messages)?void 0:t.failed,[3,6];case 4:if(!(!b&&(0,a.X1t)(o,(0,a.nW9)(l,v))))return[3,6];return[4,u.fetcher(o,(0,a.nW9)(l,v))];case 5:I=E.sent(),g=null==(e=null==o?void 0:o.messages)?void 0:e.failed,E.label=6;case 6:if(I&&!I.ok)return(null==(n=b?s:o)?void 0:n.silent)||u.notify("error",null!=g?g:I.msg||d("saveFailed")),x=b?"addFail":"editFail",this.dispatchEvent(x,{index:m[m.length-1],indexPath:m.join("."),item:v,error:I}),[2];return I&&I.ok&&(v=(0,i.pi)((0,i.pi)({},(b?s:o).replaceData?{}:v),I.data)),Reflect.deleteProperty(v,f),C=h,h=(0,a.o5f)(h,m,1,v),this.reUseRowId(h,C,m),this.setState((0,i.pi)((0,i.pi)({editIndex:"",items:h},this.transformState(h)),{columns:this.buildColumns(this.props)}),function(){return(0,i.mG)(w,void 0,void 0,function(){var t;return(0,i.Jh)(this,function(e){switch(e.label){case 0:return[4,this.emitValue()];case 1:if(e.sent())return[2];return t=b?"addSuccess":"editSuccess",this.dispatchEvent(t,{index:m[m.length-1],indexPath:m.join("."),item:v}),[2]}})})}),[2]}})})},e.prototype.cancelEdit=function(){var t=this.state.items.concat(),e=this.state.lastModifiedRow,n=this.state.editIndex.split(".").map(function(t){return parseInt(t,10)}),r=(0,i.pi)({},(0,a.IMU)(t,n)),s=r.hasOwnProperty(f),o=t;s?t=(0,a.o5f)(t,n,1):e&&~(null==e?void 0:e.index)&&(0,a.Kn2)(null==e?void 0:e.data)&&(t=(0,a.o5f)(t,n,1,(0,i.pi)((0,i.pi)({},r),e.data))),this.reUseRowId(t,o,n),this.setState((0,i.pi)((0,i.pi)({editIndex:"",items:t},this.transformState(t)),{columns:this.buildColumns(this.props),lastModifiedRow:void 0}),this.emitValue)},e.prototype.removeItem=function(t){var e,n;return(0,i.mG)(this,void 0,void 0,function(){var r,s,o,l,u,d,c,p,h,m,f,v,b,y=this;return(0,i.Jh)(this,function(I){switch(I.label){case 0:if(s=(r=this.props).value,r.onChange,o=r.deleteApi,l=r.deleteConfirmText,u=r.env,d=r.data,c=r.translate,p=Array.isArray(s)?s.concat():[],h=t.split(".").map(function(t){return parseInt(t,10)}),!(m=(0,a.IMU)(p,h)))return[2];return[4,this.dispatchEvent("delete",{index:h[h.length-1],indexPath:h.join("."),item:m})];case 1:if(I.sent())return[2];if(f=(0,a.nW9)(d,m),!(0,a.X1t)(o,f))return[3,4];return[4,u.confirm(l?(0,a.hXT)(l,f):c("deleteConfirm"))];case 2:if(!I.sent())return[2];return[4,u.fetcher(o,f)];case 3:if(!(v=I.sent()).ok)return(null==o?void 0:o.silent)||u.notify("error",null!=(n=null==(e=null==o?void 0:o.messages)?void 0:e.failed)?n:c("deleteFailed")),this.dispatchEvent("deleteFail",{index:h[h.length-1],indexPath:h.join("."),item:m,error:v}),[2];I.label=4;case 4:return this.removeEntry(m),b=p,p=(0,a.o5f)(p,h,1),this.reUseRowId(p,b,h),this.setState((0,i.pi)({items:p},this.transformState(p)),function(){return(0,i.mG)(y,void 0,void 0,function(){return(0,i.Jh)(this,function(t){switch(t.label){case 0:return[4,this.emitValue(p)];case 1:if(t.sent())return[2];return this.dispatchEvent("deleteSuccess",{value:p,index:h[h.length-1],indexPath:h.join("."),item:m}),[2]}})})}),[2]}})})},e.prototype.convertToRawPath=function(t,e){var n=(0,i.pi)((0,i.pi)({},this.state),e),r=n.filteredItems,a=n.items,s="".concat(t).split(".").map(function(t){return parseInt(t,10)}),o=r[s[0]];return(s[0]=a.findIndex(function(t){return t===o}),-1===s[0])?t:s.join(".")},e.prototype.reUseRowId=function(t,e,n){for(var i=e,r=t,a=0,s=n.length;a<s;a++){var o=n[a];if(!(null==i?void 0:i[o])||!(null==r?void 0:r[o]))break;this.entries.set(r[o],this.entries.get(i[o])||this.entityId++),this.entries.delete(i[o]),r=r[o].children,i=i[o].children}},e.prototype.buildItemProps=function(t,e){var n={},i=this.resolveVariableProps(this.props,"minLength"),r=this.resolveVariableProps(this.props,"maxLength");return(n.inputTableCanAddItem=!r||r>this.state.items.length,n.inputTableCanRemoveItem=!i||i<this.state.items.length,!1===this.props.needConfirm)?n.quickEditEnabled=!0:(this.props.editable||this.props.addable||this.state.isCreateMode)&&(n.quickEditEnabled=this.state.editIndex===this.convertToRawPath(t.path)),n},e.prototype.buildColumns=function(t,e,n){var o=this;void 0===e&&(e=!1);var u=this.props,d=u.env,c=u.enableStaticTransform,p=u.mobileUI,h=u.testIdBuilder,m=Array.isArray(t.columns)?t.columns.concat():[],v=this.props.classPrefix,b=this.props.translate,y=this.props.needConfirm,I=this.props.static,g=this.props.disabled,x=[];if(!I&&t.addable&&!1!==t.showTableAddBtn&&x.push({children:function(e){var n=e.key,i=e.rowIndexPath,a=e.inputTableCanAddItem;return o.state.editIndex&&!1!==y||!a?null:r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("Table.addRow"),tooltipContainer:t.popOverContainer||d.getModalContainer,disabled:g,onClick:o.addItem.bind(o,o.convertToRawPath(i),void 0,void 0),testIdBuilder:null==h?void 0:h.getChild("addRow-".concat(o.convertToRawPath(i)))},t.addBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.addBtnIcon,className:"icon"}):null,t.addBtnLabel?r.createElement("span",null,t.addBtnLabel):null)}}),!I&&t.childrenAddable&&!1!==t.showTableAddBtn&&x.push({children:function(e){var n=e.key,i=e.rowIndexPath,a=e.row;return o.state.editIndex&&!1!==y?null:r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("Table.subAddRow"),tooltipContainer:t.popOverContainer||d.getModalContainer,disabled:g,onClick:o.subAddItem.bind(o,o.convertToRawPath(i),void 0,a),testIdBuilder:null==h?void 0:h.getChild("subAddRow-".concat(o.convertToRawPath(i)))},t.subAddBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.subAddBtnIcon,className:"icon"}):null,t.subAddBtnLabel?r.createElement("span",null,t.subAddBtnLabel):null)}}),!I&&t.copyable&&!1!==t.showCopyBtn&&x.push({children:function(e){var n=e.key,i=e.rowIndexPath;return o.state.editIndex&&!1!==y?null:r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("Table.copyRow"),tooltipContainer:t.popOverContainer||d.getModalContainer,disabled:g,onClick:o.copyItem.bind(o,o.convertToRawPath(i),void 0),testIdBuilder:null==h?void 0:h.getChild("copyRow-".concat(o.convertToRawPath(i)))},t.copyBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.copyBtnIcon,className:"icon"}):null,t.copyBtnLabel?r.createElement("span",null,t.copyBtnLabel):null)}}),!1===t.needConfirm?m=m.map(function(t){var e=t.quickEdit;return!1===e?l()(t,["quickEdit"]):(0,i.pi)((0,i.pi)({},t),"operation"===t.type?{}:{quickEdit:(0,i.pi)((0,i.pi)((0,i.pi)({},o.columnToQuickEdit(t)),e),{visibleOn:"",hiddenOn:"",visible:!0,hidden:!1,saveImmediately:!0,mode:"inline",disabled:g,static:I||t.static})})}):!0!==I&&(t.addable||t.editable||e)?(m=m.map(function(r,s){var u=!e&&r.hasOwnProperty("quickEditOnUpdate")?r.quickEditOnUpdate:r.quickEdit,d=(0,a.SL$)(null==r?void 0:r.type);return(0,i.pi)((0,i.pi)({},!1===u?l()(r,["quickEdit"]):(0,i.pi)((0,i.pi)({},r),{quickEdit:(0,i.pi)((0,i.pi)((0,i.pi)({},o.columnToQuickEdit(r)),u),{visibleOn:"",hiddenOn:"",visible:!0,hidden:!1,isQuickEditFormMode:!!(null==d?void 0:d.isFormItem),saveImmediately:!0,mode:"inline",disabled:g})})),c&&!1!==t.needConfirm?{staticOn:"".concat(!e," || data.index !== '").concat(n,"'")}:{})}),!I&&t.editable&&x.push({children:function(e){var n=e.key,i=e.rowIndexPath,a=e.data;return o.state.editIndex||a&&a.hasOwnProperty(f)?null:r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("Table.editRow"),tooltipContainer:t.popOverContainer||d.getModalContainer,disabled:g,onClick:function(){return o.editItem(o.convertToRawPath(i))},testIdBuilder:null==h?void 0:h.getChild("editRow-".concat(o.convertToRawPath(i)))},void 0!==t.updateBtnIcon?t.updateBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.updateBtnIcon,className:"icon"}):null:t.editBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.editBtnIcon,className:"icon"}):null,t.updateBtnLabel||t.editBtnLabel?r.createElement("span",null,t.updateBtnLabel||t.editBtnLabel):null)}}),I||x.push({children:function(e){var n=e.key,i=e.rowIndexPath;return o.state.editIndex===o.convertToRawPath(i)?r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("save"),tooltipContainer:t.popOverContainer||d.getModalContainer,onClick:o.confirmEdit,testIdBuilder:null==h?void 0:h.getChild("confirmRow-".concat(o.convertToRawPath(i)))},t.confirmBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.confirmBtnIcon,className:"icon"}):null,t.confirmBtnLabel?r.createElement("span",null,t.confirmBtnLabel):null):null}}),I||x.push({children:function(e){var n=e.key,i=e.rowIndexPath;return o.state.editIndex===o.convertToRawPath(i)?r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("cancel"),tooltipContainer:t.popOverContainer||d.getModalContainer,onClick:o.cancelEdit,testIdBuilder:null==h?void 0:h.getChild("cancelRow-".concat(o.convertToRawPath(i)))},t.cancelBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.cancelBtnIcon,className:"icon"}):null,t.cancelBtnLabel?r.createElement("span",null,t.cancelBtnLabel):null):null}})):m=m.map(function(t){var e=(0,a.SL$)(null==t?void 0:t.type);return(null==e?void 0:e.isFormItem)?(0,i.pi)((0,i.pi)({},t),{quickEdit:(0,i.pi)((0,i.pi)({},t),{visibleOn:"",hiddenOn:"",visible:!0,hidden:!1,isFormMode:!0})}):t}),!I&&t.removable&&x.push({children:function(e){var n=e.key,i=e.rowIndexPath,a=e.data,l=e.inputTableCanRemoveItem;return(o.state.editIndex||a&&a.hasOwnProperty(f))&&!1!==y||!l?null:r.createElement(s.zx,{classPrefix:v,size:"sm",key:n,level:"link",tooltip:b("Table.deleteRow"),tooltipContainer:t.popOverContainer||d.getModalContainer,disabled:g,onClick:o.removeItem.bind(o,o.convertToRawPath(i)),testIdBuilder:null==h?void 0:h.getChild("delRow-".concat(o.convertToRawPath(i)))},t.deleteBtnIcon?r.createElement(s.JO,{cx:t.classnames,icon:t.deleteBtnIcon,className:"icon"}):null,t.deleteBtnLabel?r.createElement("span",null,t.deleteBtnLabel):null)}}),x.length){var C=m.find(function(t){return"operation"===t.type});C||(C={type:"operation",buttons:[],label:b("Table.operation"),className:"v-middle nowrap",fixed:p?"":"right",width:150,innerClassName:"m-n"},m.push(C)),C.buttons=Array.isArray(C.buttons)?C.buttons.concat():[],C.buttons.unshift.apply(C.buttons,x),C.hasOwnProperty("quickEdit")&&delete C.quickEdit}return m},e.prototype.columnToQuickEdit=function(t){var e;return(null==(e=(0,a.SL$)(null==t?void 0:t.type))?void 0:e.isFormItem)||~["group"].indexOf(t.type)?(0,i.pi)((0,i.pi)({},t),{label:""}):{type:"input-text"}},e.prototype.handleTableSave=function(t,e,n){var r,s=this;this.setState(function(e,o){var l={},u=e.editIndex,d=e.lastModifiedRow,c=e.items.concat();if(Array.isArray(t))n.forEach(function(n,r){var o=(n=s.convertToRawPath(n,e)).split(".").map(function(t){return parseInt(t,10)}),l=(0,i.pi)({},(0,a.IMU)(t,o));c=(0,a.o5f)(c,o,1,l)});else{if(n=s.convertToRawPath(n,e),u&&n===u){var p=u.split(".").map(function(t){return parseInt(t,10)}),h=e.items.concat(),m=(0,a.IMU)(h,p);if(!m)return l;var v=(0,i.pi)({},t),b=h;return h=(0,a.o5f)(h,p,1,v),s.reUseRowId(h,b,p),Object.assign(l,(0,i.pi)({items:h,filteredItems:e.filteredItems.map(function(t){return t===m?v:t}),rowIndex:u},(null==d?void 0:d.index)===u?{}:{lastModifiedRow:m.hasOwnProperty(f)?void 0:{index:u,data:(0,i.pi)({},m)}})),l}var y=n.split(".").map(function(t){return parseInt(t,10)}),I=(0,i.pi)({},t),g=c;c=(0,a.o5f)(c,y,1,I),s.reUseRowId(c,g,y)}return Object.assign(l,(0,i.pi)({items:c,rowIndex:n},s.transformState(c,e))),r=s.lazyEmitValue,l},function(){r&&r()})},e.prototype.handleRadioChange=function(t,e){var n,r=this,s=e.name,o=e.row,l=e.trueValue,u=void 0===l||l,d=e.falseValue,c=void 0!==d&&d;return this.setState(function(t,e){var l=o.path,d=(0,a.GyU)(t.items,function(t,e,n,r,a){var o;return(0,i.pi)((0,i.pi)({},t),((o={})[s]=l===a.join(".")?u:c,o))});return n=t.editIndex==o.path?void 0:r.lazyEmitValue,(0,i.pi)({items:d},r.transformState(d))},function(){null==n||n()}),!1},e.prototype.handleSaveTableOrder=function(t,e){(0,this.props.onChange)(e.map(function(t){return(0,i.pi)({},t)}))},e.prototype.handlePageChange=function(t){this.setState((0,i.pi)({},this.transformState(this.state.items,{page:t})))},e.prototype.handleTableQuery=function(t){t=(0,i.pi)((0,i.pi)({},this.state.query),t),this.setState((0,i.pi)({query:t},this.transformState(this.state.items,{query:t})))},e.prototype.handlePristineChange=function(t,e){var n=this,r=this.props.needConfirm,s=e.split(".").map(function(t){return parseInt(t,10)});this.setState(function(e){var r=e.items.concat(),o=(0,a.IMU)(r,s),l=(0,i.pi)((0,i.pi)({},o),t),u=r;return r=(0,a.o5f)(r,s,1,l),n.reUseRowId(r,u,s),(0,i.pi)({items:r},n.transformState(r))},function(){!1===r&&n.emitValue()})},e.prototype.removeEntry=function(t){this.entries.has(t)&&this.entries.delete(t)},e.prototype.getEntryId=function(t){return this.entries.has(t)||this.entries.set(t,this.entityId++),String(this.entries.get(t))},e.prototype.tableRef=function(t){for(;t&&t.getWrappedInstance;)t=t.getWrappedInstance();this.table=t},e.prototype.computedAddBtnDisabled=function(){return this.props.disabled||!!this.state.editIndex},e.prototype.filterItemIndex=function(t){return this.convertToRawPath(t)},e.prototype.render=function(){var t=this,e=this.props,n=e.className,a=(e.style,e.value,e.disabled),s=e.render,o=e.placeholder,l=e.draggable,u=e.addable,d=e.columnsTogglable,c=e.combineNum,p=e.combineFromIndex,h=e.translate,m=e.canAccessSuperData,f=e.expandConfig,v=e.affixRow,b=e.prefixRow,y=e.formInited,I=e.perPage,g=e.classnames,x=e.rowClassName,C=e.rowClassNameExpr,w=e.affixHeader,E=e.autoFillHeight,P=e.tableContentClassName,R=e.static,k=e.showFooterAddBtn,S=e.footerAddBtn,T=e.toolbarClassName,A=e.onEvent,B=e.testIdBuilder,F=e.showIndex,O=this.resolveVariableProps(this.props,"maxLength");if(!1===y)return null;var L=this.state.query,V=this.state.filteredItems;this.state.items;var J="number"==typeof I,M=this.state.page||1,N=!R&&u&&!1!==k&&(!O||O>this.state.items.length);return r.createElement("div",{className:g("InputTable",n)},s("body",{type:"table",placeholder:h(o),columns:this.state.columns,affixHeader:void 0!==w&&w,prefixRow:b,affixRow:v,autoFillHeight:void 0!==E&&E,tableContentClassName:P,onEvent:A,showIndex:F},{ref:this.tableRef,value:void 0,saveImmediately:!0,disabled:a,draggable:l&&!this.state.editIndex,items:V,getEntryId:this.getEntryId,reUseRow:"match",onSave:this.handleTableSave,onRadioChange:this.handleRadioChange,onSaveOrder:this.handleSaveTableOrder,buildItemProps:this.buildItemProps,quickEditFormRef:this.subFormRef,quickEditFormItemRef:this.subFormItemRef,columnsTogglable:d,combineNum:c,combineFromIndex:p,expandConfig:f,canAccessSuperData:m,rowClassName:x,rowClassNameExpr:C,onPristineChange:this.handlePristineChange,testIdBuilder:null==B?void 0:B.getChild("table"),onQuery:this.handleTableQuery,query:L,orderBy:null==L?void 0:L.orderBy,orderDir:null==L?void 0:L.orderDir,filterItemIndex:this.filterItemIndex}),N||J?r.createElement("div",{className:g("InputTable-toolbar",T)},N?s("button",(0,i.pi)({type:"button",level:"primary",size:"sm",label:h("Table.add"),icon:"fa fa-plus",disabledTip:h("Table.addButtonDisabledTip")},S||{}),{disabled:this.computedAddBtnDisabled(),onClick:function(){return t.addItem()},testIdBuilder:null==B?void 0:B.getChild("add")}):null,J?s("pager",{type:"pagination"},{activePage:M,perPage:I,total:this.state.total,onPageChange:this.handlePageChange,className:"InputTable-pager",testIdBuilder:null==B?void 0:B.getChild("page"),disabled:!!this.state.editIndex}):null):null)},e.defaultProps={placeholder:"placeholder.empty",scaffold:{},addBtnIcon:"plus",subAddBtnIcon:"sub-plus",copyBtnIcon:"copy",editBtnIcon:"pencil",deleteBtnIcon:"minus",confirmBtnIcon:"check",cancelBtnIcon:"close",valueField:"",minLength:0,maxLength:1/0,showFooterAddBtn:!0,showTableAddBtn:!0},e.propsList=["onChange","name","columns","label","scaffold","showTableAddBtn","addable","removable","copyable","editable","addApi","updateApi","deleteApi","needConfirm","canAccessSuperData","formStore","footerActions","toolbarClassName"],(0,i.gn)([a.NjZ,(0,i.w6)("design:type",Function),(0,i.w6)("design:paramtypes",[Object,String]),(0,i.w6)("design:returntype",void 0)],e.prototype,"handlePristineChange",null),e}(r.Component),b=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return(0,i.ZT)(e,t),e.prototype.setData=function(t,e,n,r){return(0,i.mG)(this,void 0,void 0,function(){var e,s,o,l,u=this;return(0,i.Jh)(this,function(d){switch(d.label){case 0:if(this.state.items.length,void 0===n)return[3,1];return e=(0,i.ev)([],(0,i.CR)(this.state.items),!1),String(n).split(",").forEach(function(n){var i=n.split(".").map(function(t){return parseInt(t,10)}),r=e;e=(0,a.o5f)(e,i,1,t),u.reUseRowId(e,r,i)}),this.setState((0,i.pi)({items:e},this.transformState(e)),function(){u.emitValue()}),[3,4];case 1:if(void 0===r)return[3,3];return s=(0,i.ev)([],(0,i.CR)(this.state.items),!1),o=[],(0,a.P8h)(s,function(e,n,l,d,c){return o.unshift(function(){return(0,i.mG)(u,void 0,void 0,function(){var o;return(0,i.Jh)(this,function(l){switch(l.label){case 0:return[4,(0,a.Cjz)(r,e)];case 1:return l.sent()&&(o=s,s=(0,a.o5f)(s,(0,i.ev)((0,i.ev)([],(0,i.CR)(c),!1),[n],!1),1,t),this.reUseRowId(s,o,(0,i.ev)((0,i.ev)([],(0,i.CR)(c),!1),[n],!1))),[2]}})})}),!0}),[4,Promise.all(o.map(function(t){return t()}))];case 2:return d.sent(),this.setState((0,i.pi)({items:s},this.transformState(s)),function(){u.emitValue()}),[3,4];case 3:l=(0,i.ev)([],(0,i.CR)(t),!1),this.setState((0,i.pi)({items:l},this.transformState(l)),function(){u.emitValue()}),d.label=4;case 4:return[2]}})})},e.prototype.doAction=function(e,n,r,s){var o,l,u,c,p,h,m;return void 0===r&&(r=!1),(0,i.mG)(this,void 0,void 0,function(){var f,v,b,y,I,g,x,C,w,E,P,R,k,S,T,A,B,F,O,L,V,J,M,N=this;return(0,i.Jh)(this,function(U){switch(U.label){case 0:if(v=(f=this.props).valueField,b=f.env,y=f.needConfirm,f.addable,I=f.addApi,g=f.deleteApi,x=f.resetValue,C=f.translate,w=f.onChange,E=f.formStore,P=f.store,R=f.name,k=e.actionType,S=(null==(o=this.props.store)?void 0:o.data)||{},"addItem"!==k)return[3,6];if(T=this.state.items.concat(),!(I||s))return[3,4];if(A=null,!(0,a.X1t)(I,S))return[3,2];return[4,b.fetcher(I,S)];case 1:if((B=U.sent())&&!B.ok)return(null==I?void 0:I.silent)||b.notify("error",null!=(u=null==(l=null==I?void 0:I.messages)?void 0:l.failed)?u:B.msg||C("fetchFailed")),[2];return B&&B.ok&&(A=B.data),[3,3];case 2:A=s.item,U.label=3;case 3:return A=(Array.isArray(A)?A:[A]).filter(function(t){return!v||!d()(T,function(e){return e[v]==t[v]})}),F=[],"string"==typeof s.index&&/^\d+(\.\d+)*$/.test(s.index)?F=s.index.split(".").map(function(t){return parseInt(t,10)}):"number"==typeof s.index&&(F=[s.index]),F.length?T=a.o5f.apply(void 0,(0,i.ev)([T,F,0],(0,i.CR)(A),!1)):T.push.apply(T,(0,i.ev)([],(0,i.CR)(A),!1)),this.setState((0,i.pi)({items:T},this.transformState(T)),function(){if(1===A.length&&!1!==y){var t=F.concat();t[t.length-1]+=1,N.startEdit(t.join("."),!0)}else null==w||w(T)}),[2];case 4:return[2,this.addItem("".concat(T.length-1),!1)];case 5:return[3,13];case 6:if("deleteItem"!==k)return[3,12];if(O=(0,i.ev)([],(0,i.CR)(this.state.items),!1),L=[],(null==s?void 0:s.index)===void 0)return[3,7];return String(s.index).split(",").forEach(function(t){var e=t.split(".").map(function(t){return parseInt(t,10)});L.push((0,a.IMU)(O,e)),O=(0,a.o5f)(O,e,1)}),[3,9];case 7:if((null==s?void 0:s.condition)===void 0)return[3,9];return V=[],(0,a.P8h)(O,function(t,e,n,r,o){return V.unshift(function(){return(0,i.mG)(N,void 0,void 0,function(){return(0,i.Jh)(this,function(n){switch(n.label){case 0:return[4,(0,a.Cjz)(null==s?void 0:s.condition,t)];case 1:return n.sent()&&(L.push(t),O=(0,a.o5f)(O,(0,i.ev)((0,i.ev)([],(0,i.CR)(o),!1),[e],!1),1)),[2]}})})}),!0}),[4,V.reduce(function(t,e){return t.then(e)},Promise.resolve())];case 8:U.sent(),U.label=9;case 9:if(!(0,a.X1t)(g,(0,a.nW9)(S,{deletedItems:L})))return[3,11];return[4,b.fetcher(g,(0,a.nW9)(S,{deletedItems:L}))];case 10:if((B=U.sent())&&!B.ok)return(null==g?void 0:g.silent)||b.notify("error",null!=(p=null==(c=null==g?void 0:g.messages)?void 0:c.failed)?p:B.msg||C("fetchFailed")),[2];U.label=11;case 11:return this.setState((0,i.pi)({items:O},this.transformState(O)),function(){null==w||w(O)}),[2];case 12:if("clear"===k)return this.setState({items:[]},function(){null==w||w([])}),[2];if("reset"===k)return M=Array.isArray(J=null!=(m=(0,a.E04)(null!=(h=null==E?void 0:E.pristine)?h:null==P?void 0:P.pristine,R))?m:x)?J:[],this.setState((0,i.pi)({items:M},this.transformState(M)),function(){null==w||w(M)}),[2];U.label=13;case 13:return[2,t.prototype.doAction.call(this,e,n,r,S)]}})})},e=(0,i.gn)([(0,a.xJW)({type:"input-table"})],e)}(v)}}]);