"use strict";(self.webpackChunkvue2_amis=self.webpackChunkvue2_amis||[]).push([["7102"],{40528:function(t,e,r){r.r(e),r.d(e,{ServiceRenderer:()=>m,default:()=>v,eventTypes:()=>f});var a=r(9787),i=r(65758),n=r(51760),o=r.n(n),s=r(32222),c=r.n(s),d=r(47755),h=r(68333),u=r(69143),p=r.n(u),l=r(6663),f=["inited","onApiFetched","onSchemaApiFetched","onWsFetched"],v=function(t){function e(e){var r=t.call(this,e)||this;return r.dataProviders=r.initDataProviders(e.dataProvider),r.handleQuery=r.handleQuery.bind(r),r.handleAction=r.handleAction.bind(r),r.handleChange=r.handleChange.bind(r),r.reload=r.reload.bind(r),r.silentReload=r.silentReload.bind(r),r.initInterval=r.initInterval.bind(r),r.afterDataFetch=r.afterDataFetch.bind(r),r.afterSchemaFetch=r.afterSchemaFetch.bind(r),r.runDataProvider=r.runDataProvider.bind(r),r.dataProviderSetData=r.dataProviderSetData.bind(r),r}return(0,a.ZT)(e,t),e.prototype.componentDidMount=function(){return(0,a.mG)(this,void 0,void 0,function(){var t,e,r,i;return(0,a.Jh)(this,function(a){switch(a.label){case 0:return e=(t=this.props).data,r=t.dispatchEvent,this.mounted=!0,[4,r("init",e,this)];case 1:if(null==(i=a.sent())?void 0:i.prevented)return[2];return this.initFetch(),[2]}})})},e.prototype.componentDidUpdate=function(t){var e,r=this,a=this.props,i=a.store,n=a.messages,o=n.fetchSuccess,s=n.fetchFailed;a.dataProvider!==t.dataProvider&&(this.dataProviders=this.initDataProviders(a.dataProvider),this.dataProviders&&(null==(e=this.dataProviders)?void 0:e.inited)&&this.runDataProvider("inited")),(0,d.rMT)(t.api,a.api,t.data,a.data)&&(0,d.X1t)(a.api,i.data)&&i.fetchData(a.api,i.data,{successMessage:o,errorMessage:s}).then(function(t){r.runDataProvider("onApiFetched"),r.afterDataFetch(t)}),(0,d.rMT)(t.schemaApi,a.schemaApi,t.data,a.data)&&(0,d.X1t)(a.schemaApi,i.data)&&i.fetchSchema(a.schemaApi,i.data,{successMessage:o,errorMessage:s}).then(function(t){r.runDataProvider("onSchemaApiFetched"),r.afterSchemaFetch(t)}),a.ws&&t.ws!==a.ws&&(this.socket&&this.socket.close(),this.socket=this.fetchWSData(a.ws,i.data)),(0,d.RjM)(t.defaultData,a.defaultData)&&i.reInitData(a.defaultData)},e.prototype.componentWillUnmount=function(){this.mounted=!1,this.runDataProviderUnsubscribe(),clearTimeout(this.timer),this.socket&&this.socket.close&&this.socket.close()},e.prototype.doAction=function(t,e,r,a){if(void 0===r&&(r=!1),(null==t?void 0:t.actionType)==="rebuild"){var i=this.props,n=i.schemaApi,o=i.store,s=i.dataProvider,c=i.messages,h=c.fetchSuccess,u=c.fetchFailed;o.updateData(a),clearTimeout(this.timer),(0,d.X1t)(n,o.data)&&o.fetchSchema(n,o.data,{successMessage:h,errorMessage:u}).then(this.afterSchemaFetch),s&&this.runDataProvider("inited")}},e.prototype.initFetch=function(){var t=this,e=this.props,r=e.schemaApi,a=e.initFetchSchema,i=e.api,n=e.ws,o=e.initFetch,s=e.initFetchOn,c=e.dataProvider,h=e.store,u=e.messages,p=u.fetchSuccess,l=u.fetchFailed;(0,d.X1t)(r,h.data,a)&&h.fetchSchema(r,h.data,{successMessage:p,errorMessage:l}).then(function(e){t.runDataProvider("onSchemaApiFetched"),t.afterSchemaFetch(e)}),(0,d.X1t)(i,h.data,o,s)&&h.fetchInitData(i,h.data,{successMessage:p,errorMessage:l}).then(function(e){t.runDataProvider("onApiFetched"),t.afterDataFetch(e)}),n&&(this.socket=this.fetchWSData(n,h.data)),c&&this.runDataProvider("inited")},e.prototype.initDataProviders=function(t){var e=this,r=p()(t)?c()(t):t,a={};if(r)if(p()(r))Object.keys(r).forEach(function(t){var i=e.normalizeProvider(r[t],t);a=o()(a,i||{})});else{var i=this.normalizeProvider(r,"inited");a=o()(a,i||{})}return a},e.prototype.normalizeProvider=function(t,e){var r,a;if(void 0===e&&(e="inited"),!~f.indexOf(e))return null;if("function"==typeof t)return(r={})[e]=t,r;if("string"==typeof t){var i=(0,d.S0D)(t,"data","setData","env");return i?((a={})[e]=i,a):null}return null},e.prototype.runDataProvider=function(t){return(0,a.mG)(this,void 0,void 0,function(){var e,r,i,n;return(0,a.Jh)(this,function(a){switch(a.label){case 0:if(this.runDataProviderUnsubscribe(t),e=this.props.store,!((r=this.dataProviders)&&~f.indexOf(t))||!((i=r[t])&&"function"==typeof i))return[3,2];return[4,i(e.data,this.dataProviderSetData,this.props.env)];case 1:"function"==typeof(n=a.sent())&&(this.dataProviderUnsubscribe||(this.dataProviderUnsubscribe={}),this.dataProviderUnsubscribe[t]=n),a.label=2;case 2:return[2]}})})},e.prototype.runDataProviderUnsubscribe=function(t){var e,r=this.dataProviderUnsubscribe;if(r)if(t){var a=r[t];try{a&&"function"==typeof a&&a()}catch(t){console.error(t)}}else null==(e=Object.keys(r))||e.forEach(function(t){var e=r[t];try{e&&"function"==typeof e&&e()}catch(t){console.error(t)}})},e.prototype.dataProviderSetData=function(t){if(this.mounted){var e=this.props.store;e.updateData(t,void 0,!1),e.setHasRemoteData()}},e.prototype.fetchWSData=function(t,e){var r=this,a=this.props,i=a.env,n=a.store,o=(0,d.xkX)(t,e);i.wsFetcher(o,function(t){var e,a,s,c,d=t;if("status"in t&&"data"in t&&(d=t.data,0!==t.status)){n.updateMessage(null!=(a=null==(e=null==o?void 0:o.messages)?void 0:e.failed)?a:t.msg,!0),i.notify("error",null!=(c=null==(s=null==o?void 0:o.messages)?void 0:s.failed)?c:t.msg);return}n.updateData(d,void 0,!1,o.concatDataFields),n.setHasRemoteData(),r.runDataProvider("onWsFetched"),r.afterDataFetch({ok:!0,data:d})},function(t){n.updateMessage(t,!0),i.notify("error",t)})},e.prototype.afterDataFetch=function(t){var e,r=(null==t?void 0:t.hasOwnProperty("ok"))?null!=(e=t.data)?e:{}:t,i=this.props,n=i.onBulkChange,o=i.dispatchEvent,s=i.store,c=i.formStore;(0,l.fh)(s)&&(null==o||o("fetchInited",(0,d.nW9)(this.props.data,(0,a.pi)((0,a.pi)({},r),{__response:{msg:s.msg,error:s.error},responseData:r,responseStatus:(null==t?void 0:t.status)===void 0?+!!s.error:null==t?void 0:t.status,responseMsg:s.msg}))),!(0,d.xbD)(r)&&n&&c&&n(r,!1,{type:"api"}),(null==t?void 0:t.ok)&&this.initInterval(r))},e.prototype.afterSchemaFetch=function(t){var e=this.props,r=e.onBulkChange,i=e.formStore,n=e.dispatchEvent,o=e.store;null==n||n("fetchSchemaInited",(0,a.pi)((0,a.pi)({},t),{__response:{msg:o.msg,error:o.error},responseData:t,responseStatus:(null==t?void 0:t.status)===void 0?+!!o.error:null==t?void 0:t.status,responseMsg:o.msg})),i&&(null==t?void 0:t.data)&&r&&r&&r(t.data),this.initInterval(t)},e.prototype.initInterval=function(t){var e=this.props,r=e.interval,a=e.silentPolling,i=e.stopAutoRefreshWhen,n=e.data;return clearTimeout(this.timer),r&&this.mounted&&(!i||!(0,d.fz_)(i,(0,d.nW9)(n,t)))&&(this.timer=setTimeout(a?this.silentReload:this.reload,Math.max(r,1e3))),t},e.prototype.reload=function(t,e,r,i,n){return(0,a.mG)(this,void 0,void 0,function(){var t,r,o,s,c,h,u,p,l;return(0,a.Jh)(this,function(a){switch(a.label){case 0:if(e)return[2,this.receive(e,void 0,n)];if(r=(t=this.props).schemaApi,t.initFetchSchema,o=t.api,t.initFetch,t.initFetchOn,s=t.store,c=t.dataProvider,u=(h=t.messages).fetchSuccess,p=h.fetchFailed,clearTimeout(this.timer),!(0,d.X1t)(r,s.data))return[3,3];return[4,s.fetchSchema(r,s.data,{successMessage:u,errorMessage:p})];case 1:return l=a.sent(),[4,this.runDataProvider("onApiFetched")];case 2:a.sent(),this.afterSchemaFetch(l),a.label=3;case 3:if(!(0,d.X1t)(o,s.data))return[3,6];return[4,s.fetchData(o,s.data,{silent:i,successMessage:u,errorMessage:p})];case 4:return l=a.sent(),[4,this.runDataProvider("onSchemaApiFetched")];case 5:a.sent(),this.afterDataFetch(l),a.label=6;case 6:if(!c)return[3,8];return[4,this.runDataProvider("inited")];case 7:a.sent(),a.label=8;case 8:return[2,s.data]}})})},e.prototype.silentReload=function(t,e){this.reload(t,e,void 0,!0)},e.prototype.receive=function(t,e,r){return(0,a.mG)(this,void 0,void 0,function(){return(0,a.Jh)(this,function(e){return this.props.store.updateData(t,void 0,r),[2,this.reload()]})})},e.prototype.handleQuery=function(t){var e=this;return this.props.api||this.props.schemaApi?!((null==t?void 0:t.hasOwnProperty("orderBy"))&&[this.props.api,this.props.schemaApi].every(function(r){return!r||!(0,d.rMT)(r,r,e.props.store.data,(0,d.nW9)(e.props.store.data,t))}))&&void this.receive(t):!!this.props.onQuery&&this.props.onQuery(t)},e.prototype.reloadTarget=function(t,e){},e.prototype.handleDialogConfirm=function(t,e,r,a){this.props.store.closeDialog(!0,t)},e.prototype.handleDialogClose=function(t){void 0===t&&(t=!1),this.props.store.closeDialog(t)},e.prototype.openFeedback=function(t,e){var r=this;return new Promise(function(a){var i=r.props.store;i.setCurrentAction({type:"button",actionType:"dialog",dialog:t},r.props.resolveDefinitions),i.openDialog(e,void 0,function(t){a(t)},r.context)})},e.prototype.handleAction=function(t,e,r,i,n){var o=this;void 0===i&&(i=!1);var s=this.props,c=s.onAction,h=s.store,u=s.env,p=s.api,l=s.translate;p&&"ajax"===e.actionType?(h.setCurrentAction(e,this.props.resolveDefinitions),h.saveRemote(e.api,r,{successMessage:l(e.messages&&e.messages.success),errorMessage:l(e.messages&&e.messages.failed)}).then(function(t){return(0,a.mG)(o,void 0,void 0,function(){var r;return(0,a.Jh)(this,function(a){switch(a.label){case 0:if(this.afterDataFetch(t),!(e.feedback&&(0,d.pn4)(e.feedback,h.data)))return[3,2];return[4,this.openFeedback(e.feedback,h.data)];case 1:a.sent(),a.label=2;case 2:return(r=e.redirect&&(0,d.hXT)(e.redirect,h.data))&&u.jumpTo(r,e,h.data),e.reload&&this.reloadTarget((0,d.u22)(e.reload,h.data),h.data),[2]}})})}).catch(function(t){if(i||e.countDown)throw t})):c(t,e,r,i,n||this.context)},e.prototype.handleChange=function(t,e,r,a){var i,n=this.props,o=n.store,s=n.formStore,c=n.onChange;"string"==typeof e&&(null==(i=o.changeValue)||i.call(o,e,t),s&&(null==c||c(t,e,r,a)))},e.prototype.renderBody=function(){var t=this.props,e=t.render,r=t.store,a=t.body;return t.classnames,e("body",r.schema||a,{key:r.schemaKey||"body",loading:r.loading,onQuery:this.handleQuery,onAction:this.handleAction,onChange:this.handleChange})},e.prototype.render=function(){var t=this.props,e=t.className,r=t.style,n=t.store,o=t.render,s=t.env,c=t.classPrefix,d=t.classnames,u=t.loadingConfig,p=t.showErrorMsg,l=t.testIdBuilder;return i.createElement("div",(0,a.pi)({className:d("".concat(c,"Service"),e),style:r},null==l?void 0:l.getTestId()),!s.forceSilenceInsideError&&n.error&&!1!==p?i.createElement(h.Vp,{level:"danger",showCloseButton:!0,onClose:function(){return n.updateMessage("")}},n.msg):null,this.renderBody(),i.createElement(h.$j,{size:"lg",overlay:!0,key:"info",show:n.loading,loadingConfig:u}),o("modal",(0,a.pi)((0,a.pi)({},n.action&&n.action.dialog),{type:"dialog"}),{key:"dialog",data:n.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:n.dialogOpen}))},e.defaultProps={messages:{fetchFailed:"fetchFailed"},showErrorMsg:!0},e.propsList=[],(0,a.gn)([d.NjZ,(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[]),(0,a.w6)("design:returntype",void 0)],e.prototype,"initFetch",null),(0,a.gn)([d.NjZ,(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[Object]),(0,a.w6)("design:returntype",void 0)],e.prototype,"initDataProviders",null),(0,a.gn)([d.NjZ,(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[Object,String]),(0,a.w6)("design:returntype",Object)],e.prototype,"normalizeProvider",null),(0,a.gn)([d.NjZ,(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[Array,Object,Object,Array]),(0,a.w6)("design:returntype",void 0)],e.prototype,"handleDialogConfirm",null),(0,a.gn)([d.NjZ,(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[Object]),(0,a.w6)("design:returntype",void 0)],e.prototype,"handleDialogClose",null),e}(i.Component),m=function(t){function e(e,r){var a=t.call(this,e)||this;return r.registerComponent(a),a}return(0,a.ZT)(e,t),e.prototype.reload=function(e,r,i,n,o){return(0,a.mG)(this,void 0,void 0,function(){var s;return(0,a.Jh)(this,function(a){return(s=this.context,e)?[2,s.reload(r?"".concat(e,"?").concat((0,d.mUA)(r)):e,i)]:[2,t.prototype.reload.call(this,e,r,i,n,o)]})})},e.prototype.receive=function(e,r,i){return(0,a.mG)(this,void 0,void 0,function(){var n;return(0,a.Jh)(this,function(a){return(n=this.context,r)?[2,n.send(r,e)]:[2,t.prototype.receive.call(this,e,r,i)]})})},e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.prototype.reloadTarget=function(t,e){this.context.reload(t,e)},e.prototype.setData=function(t,e){return this.props.store.updateData(t,void 0,e)},e.prototype.getData=function(){return this.props.store.data},e.contextType=d.ZHe,e=(0,a.gn)([(0,d.Thl)({type:"service",storeType:d.Y5f.name,isolateScope:!0,storeExtendsData:function(t){return!t.formStore}}),(0,a.w6)("design:paramtypes",[Object,Object])],e)}(v)}}]);